<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>感謝果園 - 管理後台</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Heroicons 圖示庫 -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <div class="max-w-2xl mx-auto p-4 sm:p-6 lg:p-8 mt-10">
        
        <!-- 頂部標題 -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 flex items-center justify-center">
                <ion-icon name="server-outline" class="mr-3"></ion-icon>
                感謝果園 - 管理後台
            </h1>
            <p class="text-lg text-gray-600 mt-2">批次建立團隊成員</p>
        </header>

        <!-- 主卡片 -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden w-full">
            <div class="p-6 sm:p-8">
                
                <form id="admin-form">
                    <div class="space-y-5">
                        <div>
                            <!-- [修改] 更新標籤 -->
                            <label for="member-list" class="block text-lg font-medium text-gray-700 mb-2">成員列表 (人事號,姓名,預設密碼)</label>
                            <!-- [修改] 更新 placeholder -->
                            <textarea id="member-list" name="member-list" rows="10" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg" placeholder="請在此貼上成員列表，一行一個...&#10;格式：人事號,姓名,預設密碼&#10;例如：&#10;1001,王大明,1001&#10;1002,陳小花,1002"></textarea>
                            <!-- [修改] 加入安全聲明 -->
                            <p class="text-sm text-gray-500 mt-2">注意：程式會自動過濾空白行，並使用「人事號」作為唯一ID。</p>
                            <p class="text-sm text-red-600 font-medium mt-1">安全提醒：密碼將會「明文儲存」，僅供內部試用。</p>
                        </div>
                        
                        <div id="form-message" class="text-sm h-5"></div> <!-- 用於顯示錯誤或成功訊息 -->

                        <div>
                            <button type="submit" id="submit-button" class="w-full flex justify-center items-center px-6 py-4 border border-transparent rounded-lg shadow-sm text-xl font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition duration-200 disabled:opacity-50">
                                <ion-icon name="people-outline" class="mr-2"></ion-icon>
                                批次建立成員
                            </button>
                        </div>
                    </div>
                </form>

            </div>
        </div>

        <!-- 導覽連結 -->
        <div class="text-center mt-8 space-x-6">
            <a href="dashboard.html" class="text-lg text-gray-700 hover:text-orange-600">&larr; 返回總覽頁</a>
            <a href="member.html" class="text-lg text-gray-700 hover:text-orange-600">前往會員中心 &rarr;</a>
        </div>

    </div> <!-- End of Container -->


    <!-- 載入 Firebase SDK 並執行所有應用程式邏輯 -->
    <script type="module">
        // 載入 Firebase 核心功能
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // [修改] 移除 Firebase Auth 相關功能，因為我們改用簡易登入
        import { 
            getFirestore, 
            collection, 
            doc,
            writeBatch, // [重點] 載入批次寫入
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. 全域變數與 DOM 元素 ---
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // [修改] 移除 initialAuthToken，不再需要
        
        let app, db;
        // [修改] 移除 auth 和 isAuthReady，不再需要
        
        // DOM 元素
        const form = document.getElementById('admin-form');
        const memberList = document.getElementById('member-list');
        const submitButton = document.getElementById('submit-button');
        const messageDiv = document.getElementById('form-message');

        // --- 2. Firebase 初始化 ---
        // [修改] 簡化初始化流程，移除 Auth
        async function initializeAppAndDb() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                console.log("Firebase 初始化完成 (簡易模式)。");
            } catch (error) { 
                console.error("Firebase 初始化失敗:", error);
                showMessage("無法連接到伺服器。", 'error');
                submitButton.disabled = true;
            }
        }

        // --- 3. 核心功能：批次建立 ---
        
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!db) { // 檢查 db 是否初始化
                showMessage("尚未連接到資料庫，請稍候...", 'error');
                return;
            }
            handleBatchCreate();
        });

        async function handleBatchCreate() {
            // 1. 鎖定按鈕
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                處理中...
            `;
            showMessage('',''); // 清空訊息

            // 2. [修改] 獲取並清理名單 (CSV 格式)
            const lines = memberList.value.split('\n')
                                         .map(line => line.trim()) 
                                         .filter(line => line.length > 0); 

            if (lines.length === 0) {
                showMessage("名單為空，請輸入資料。", 'error');
                resetButton();
                return;
            }
            
            let successCount = 0;
            let errorCount = 0;
            let errorLines = [];

            try {
                // 3. 建立一個批次 (Batch)
                const batch = writeBatch(db);
                
                // [資料流修復] 定義私密和公開的路徑
                const usersColRef = collection(db, `/artifacts/${appId}/users`);
                const publicUsersColRef = collection(db, `/artifacts/${appId}/public/data/users`);

                lines.forEach(line => {
                    // [修改] 解析 3 個部分
                    const parts = line.split(',');
                    if (parts.length === 3) {
                        const id = parts[0].trim();
                        const name = parts[1].trim();
                        const password = parts[2].trim(); // [新增] 獲取密碼
                        
                        if (id.length > 0 && name.length > 0 && password.length > 0) {
                            
                            // [資料流修復] 準備「私密」資料 (包含密碼)
                            const newUserRef = doc(db, `/artifacts/${appId}/users`, id); 
                            const privateData = {
                                name: name,
                                password: password, // [!!] 明文儲存密碼
                                seeds: 7, // 初始 7 顆種子
                                apples: 0,
                                goldenApples: 0,
                                gardenerPoints: 0,
                                createdAt: serverTimestamp(),
                                lastSeedAt: null // 確保他們明天可以領種子
                            };
                            batch.set(newUserRef, privateData);

                            // [資料流修復] 準備「公開」資料 (不含密碼)
                            const publicUserRef = doc(db, `/artifacts/${appId}/public/data/users`, id);
                            const publicData = {
                                name: name,
                                apples: 0,
                                goldenApples: 0,
                                gardenerPoints: 0
                            };
                            batch.set(publicUserRef, publicData);

                            successCount++;
                        } else {
                            errorCount++;
                            errorLines.push(line);
                        }
                    } else {
                        errorCount++;
                        errorLines.push(line);
                    }
                });

                if (successCount === 0) {
                   // [修改] 更新錯誤訊息
                   showMessage("格式錯誤，請檢查 (格式：人事號,姓名,預設密碼)", 'error');
                   resetButton();
                   return; 
                }

                // 4. 提交批次 (一次性寫入所有資料)
                await batch.commit();

                // 5. 成功
                let successMessage = `成功建立了 ${successCount} 位新成員！`;
                if (errorCount > 0) {
                    successMessage += ` 有 ${errorCount} 行格式錯誤未處理。`;
                    console.warn("格式錯誤的行：", errorLines);
                }
                showMessage(successMessage, 'success');
                memberList.value = ''; // 清空輸入框

            } catch (error) {
                // 6. 失敗
                console.error("批次建立失敗:", error);
                showMessage("建立成員時發生錯誤，請稍後再試。", 'error');
            }

            // 7. 恢復按鈕
            resetButton();
        }

        // --- 4. 輔助工具 ---

        function showMessage(message, type) {
            messageDiv.textContent = message;
            if (type === 'error') {
                messageDiv.className = 'text-red-600 text-sm h-5';
            } else if (type === 'success') {
                messageDiv.className = 'text-green-600 text-sm h-5';
            } else {
                messageDiv.className = 'text-sm h-5';
            }
        }

        function resetButton() {
            submitButton.disabled = false;
            submitButton.innerHTML = `
                <ion-icon name="people-outline" class="mr-2"></ion-icon>
                批次建立成員
            `;
        }

        // --- 5. 啟動應用程式 ---
        initializeAppAndDb(); // [修改] 呼叫新的初始化函式

    </script>

</body>
</html>
