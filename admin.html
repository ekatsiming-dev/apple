<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>感謝果園 - 管理後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <div class="max-w-2xl mx-auto p-4 sm:p-6 lg:p-8 mt-10">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 flex items-center justify-center">
                <ion-icon name="server-outline" class="mr-3"></ion-icon>
                感謝果園 - 管理後台
            </h1>
            <p class="text-lg text-gray-600 mt-2">批次建立團隊成員</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden w-full">
            <div class="p-6 sm:p-8">
                
                <form id="admin-form">
                    <div class="space-y-5">
                        <div>
                            <label for="member-list" class="block text-lg font-medium text-gray-700 mb-2">成員列表 (人事號,姓名,預設密碼)</label>
                            <textarea id="member-list" name="member-list" rows="10" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg" placeholder="請在此貼上成員列表，一行一個...&#10;格式：人事號,姓名,預設密碼&#10;例如：&#10;1001,王大明,1001&#10;1002,陳小花,1002"></textarea>
                            <p class="text-sm text-gray-500 mt-2">注意：程式會自動過濾空白行，並使用「人事號」作為唯一ID。</p>
                        </div>
                        
                        <div id="form-message" class="text-sm h-5"></div> <div>
                            <button type="submit" id="submit-button" class="w-full flex justify-center items-center px-6 py-4 border border-transparent rounded-lg shadow-sm text-xl font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition duration-200 disabled:opacity-50">
                                <ion-icon name="people-outline" class="mr-2"></ion-icon>
                                批次建立成員
                            </button>
                        </div>
                    </div>
                </form>

            </div>
        </div>

        <div class="text-center mt-8 space-x-6">
            <a href="dashboard.html" class="text-lg text-gray-700 hover:text-orange-600">&larr; 返回總覽頁</a>
            <a href="member.html" class="text-lg text-gray-700 hover:text-orange-600">前往會員中心 &rarr;</a>
        </div>

    </div>

    <script type="module">
        // [!!] 已填入您提供的 Apps Script 網址
        const API_URL = 'https://script.google.com/macros/s/AKfycbz6PfmdrVdHEWOyBUskzCIR3ubwJviCd_kvRi2-XbWnzVxcGqYhHSvRb_Z88hI1Sghq/exec';
        const appId = 'default-app-id';

        // DOM 元素
        const form = document.getElementById('admin-form');
        const memberList = document.getElementById('member-list');
        const submitButton = document.getElementById('submit-button');
        const messageDiv = document.getElementById('form-message');

        // --- 核心功能：批次建立 ---
        
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            handleBatchCreate();
        });

        async function handleBatchCreate() {
            // 1. 鎖定按鈕
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                處理中...
            `;
            showMessage('',''); // 清空訊息

            const usersData = memberList.value;
            if (usersData.trim().length === 0) {
                showMessage("名單為空，請輸入資料。", 'error');
                resetButton();
                return;
            }

            try {
                // 3. 呼叫 Apps Script API (POST)
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'create_users',
                        usersData: usersData
                    }),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // Apps Script POST 需用 text/plain
                    }
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // 5. 成功
                    const { successCount, errorCount } = result.data;
                    let successMessage = `成功建立了 ${successCount} 位新成員！`;
                    if (errorCount > 0) {
                        successMessage += ` 有 ${errorCount} 行格式錯誤或已存在未處理。`;
                    }
                    showMessage(successMessage, 'success');
                    memberList.value = ''; // 清空輸入框
                } else {
                    // 6. 失敗
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error("批次建立失敗:", error);
                showMessage(error.message || "建立成員時發生錯誤，請稍後再試。", 'error');
            }

            // 7. 恢復按鈕
            resetButton();
        }

        // --- 輔助工具 ---

        function showMessage(message, type) {
            messageDiv.textContent = message;
            if (type === 'error') {
                messageDiv.className = 'text-red-600 text-sm h-5';
            } else if (type === 'success') {
                messageDiv.className = 'text-green-600 text-sm h-5';
            } else {
                messageDiv.className = 'text-sm h-5';
            }
        }

        function resetButton() {
            submitButton.disabled = false;
            submitButton.innerHTML = `
                <ion-icon name="people-outline" class="mr-2"></ion-icon>
                批次建立成員
            `;
        }
    </script>

</body>
</html>
