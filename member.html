<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ„Ÿè¬æœåœ’ - æœƒå“¡ä¸­å¿ƒ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Heroicons åœ–ç¤ºåº« -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        /* ç‚ºäº†è®“ tab å…§å®¹å¹³æ»‘é¡¯ç¤º */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-orange-50 font-sans leading-normal tracking-normal">

    <!-- é é¢å®¹å™¨ -->
    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- é ‚éƒ¨æ¨™é¡Œ -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold text-orange-600 flex items-center justify-center">
                <ion-icon name="sparkles-outline" class="mr-3"></ion-icon>
                æ„Ÿè¬æœåœ’
            </h1>
            <p class="text-xl text-gray-700 mt-3">å‚³éæ‚¨çš„æ­£å‘èƒ½é‡</p>
        </header>

        <!-- ä¸»å…§å®¹ç¶²æ ¼ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- å·¦å´æ¬„ (æˆ‘çš„ç‹€æ…‹ + å¿«é€Ÿç™¼é€) -->
            <div class="md:col-span-1 space-y-6">

                <!-- å€å¡Š Cï¼šæˆ‘çš„ç‹€æ…‹ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">æˆ‘çš„ç‹€æ…‹</h2>
                        <!-- [æ–°å¢] ç™»å‡ºæŒ‰éˆ• -->
                        <button id="logout-button" title="ç™»å‡º" class="text-gray-500 hover:text-red-600 transition duration-150">
                            <ion-icon name="log-out-outline" class="text-2xl"></ion-icon>
                        </button>
                    </div>
                    <div class="text-center mb-4">
                        <img src="https://placehold.co/100x100/FEE2D5/E98256?text=Hi!" class="w-24 h-24 rounded-full mx-auto shadow-md border-4 border-white">
                        <h3 id="user-name-display" class="text-xl font-semibold text-gray-900 mt-3">è¼‰å…¥ä¸­...</h3>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center bg-yellow-100 p-3 rounded-lg">
                            <span class="text-lg font-medium text-yellow-800">æˆ‘çš„ç¨®å­ ğŸŒ±</span>
                            <span id="seed-count" class="text-2xl font-bold text-yellow-900">0</span>
                        </div>
                        <div class="flex justify-between items-center bg-red-100 p-3 rounded-lg">
                            <span class="text-lg font-medium text-red-800">æˆ‘çš„è˜‹æœ ğŸ</span>
                            <span id="apple-count" class="text-2xl font-bold text-red-900">0</span>
                        </div>
                        <div class="flex justify-between items-center bg-yellow-400 p-3 rounded-lg">
                            <span class="text-lg font-medium text-yellow-900">é‡‘è˜‹æœ ğŸŒŸ</span>
                            <span id="golden-apple-count" class="text-2xl font-bold text-black">0</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-4 text-center">æ¯å¤©ç™»å…¥æœƒè‡ªå‹•è£œå…… 1 é¡†ç¨®å­ (ä¸Šé™ 7 é¡†)</p>
                </div>

                <!-- å€å¡Š Aï¼šå¿«é€Ÿç™¼é€ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">å¿«é€Ÿç™¼é€æ„Ÿè¬</h2>
                    <form id="send-gift-form" class="space-y-4">
                        <div>
                            <label for="receiver-select" class="block text-sm font-medium text-gray-700">æ„Ÿè¬å°è±¡</label>
                            <select id="receiver-select" name="receiver" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                                <option value="">æ­£åœ¨è¼‰å…¥åŒäº‹åå–®...</option>
                            </select>
                        </div>
                        <div>
                            <label for="gift-message" class="block text-sm font-medium text-gray-700">æ„Ÿè¬è¨Šæ¯ (å¿…å¡«)</label>
                            <textarea id="gift-message" name="message" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="è¬è¬ä½ ..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">é¸æ“‡ç¦®ç‰© (æ“‡ä¸€)</label>
                            <div class="flex space-x-2 mt-1">
                                <button type="button" data-gift-type="seed" class="gift-type-btn flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-md font-medium hover:bg-yellow-200">
                                    ç¨®å­ ğŸŒ±
                                </button>
                                <button type="button" data-gift-type="apple" class="gift-type-btn flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-md font-medium hover:bg-red-200">
                                    è˜‹æœ ğŸ
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="gift-amount" class="block text-sm font-medium text-gray-700">æ•¸é‡</label>
                            <div class="flex items-center mt-1">
                                <button type="button" id="amount-decrease" class="px-3 py-1 border border-gray-300 rounded-l-md bg-gray-100 hover:bg-gray-200">-</button>
                                <input type="number" id="gift-amount" name="amount" value="1" min="1" class="w-full text-center py-2 border-t border-b border-gray-300 focus:outline-none focus:ring-orange-500 focus:border-orange-500 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                                <button type="button" id="amount-increase" class="px-3 py-1 border border-gray-300 rounded-r-md bg-gray-100 hover:bg-gray-200">+</button>
                            </div>
                        </div>
                        <div id="gift-form-message" class="text-sm h-5 text-red-600"></div>
                        <button type="submit" id="submit-gift-button" class="w-full bg-orange-600 text-white py-2 px-4 rounded-md font-semibold shadow-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 disabled:opacity-50">
                            é€å‡ºæ„Ÿè¬
                        </button>
                    </form>
                </div>

            </div>

            <!-- å³å´æ¬„ (æ„Ÿè¬æ­·ç¨‹) -->
            <div class="md:col-span-2 space-y-6">
                
                <!-- å€å¡Š D/Eï¼šæˆ‘çš„æ„Ÿè¬æ­·ç¨‹ -->
                <div class="bg-white rounded-xl shadow-lg">
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px px-6">
                            <button data-tab="received" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-orange-500 text-orange-600">
                                æ”¶åˆ°çš„æ„Ÿè¬
                            </button>
                            <button data-tab="sent" class="tab-btn whitespace-nowrap ml-8 py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                é€å‡ºçš„æ„Ÿè¬
                            </button>
                        </nav>
                    </div>
                    
                    <!-- æ”¶åˆ°çš„æ„Ÿè¬ å…§å®¹ -->
                    <div id="tab-received" class="tab-content active p-6 space-y-4">
                        <!-- å…§å®¹å°‡ç”± JS å‹•æ…‹è¼‰å…¥ -->
                        <div id="received-list" class="divide-y divide-gray-200">
                            <p class="text-gray-500 py-4">æ­£åœ¨è¼‰å…¥æ„Ÿè¬ç´€éŒ„...</p>
                        </div>
                    </div>
                    
                    <!-- é€å‡ºçš„æ„Ÿè¬ å…§å®¹ -->
                    <div id="tab-sent" class="tab-content p-6 space-y-4">
                        <!-- å…§å®¹å°‡ç”± JS å‹•æ…‹è¼‰å…¥ -->
                        <div id="sent-list" class="divide-y divide-gray-200">
                            <p class="text-gray-500 py-4">æ­£åœ¨è¼‰å…¥æ„Ÿè¬ç´€éŒ„...</p>
                        </div>
                    </div>
                </div>

                <!-- [æ–°å¢] å€å¡Š Fï¼šä¿®æ”¹å¯†ç¢¼ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ä¿®æ”¹å¯†ç¢¼</h2>
                    <form id="change-password-form" class="space-y-4">
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-gray-700">æ–°å¯†ç¢¼</label>
                            <input type="password" id="new-password" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500 sm:text-sm py-2 px-3" placeholder="è«‹è¼¸å…¥æ‚¨çš„æ–°å¯†ç¢¼">
                        </div>
                        <div>
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700">ç¢ºèªæ–°å¯†ç¢¼</label>
                            <input type="password" id="confirm-password" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500 sm:text-sm py-2 px-3" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
                        </div>
                        <div id="password-form-message" class="text-sm h-5 text-red-600"></div>
                        <button type="submit" id="submit-password-button" class="w-full bg-gray-700 text-white py-2 px-4 rounded-md font-semibold shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50">
                            å„²å­˜æ–°å¯†ç¢¼
                        </button>
                    </form>
                </div>

                <!-- å°è¦½é€£çµ -->
                <div class="text-center mt-6">
                    <!-- [FIX] ç§»é™¤ ./ ç›¸å°è·¯å¾‘ -->
                    <a href="dashboard.html" class="text-lg text-gray-700 hover:text-orange-600">&larr; è¿”å›å…¬é–‹ç¸½è¦½é </a>
                </div>

            </div>
        </div> <!-- End of Grid -->
    </div> <!-- End of Container -->


    <!-- è¼‰å…¥ Firebase SDK ä¸¦åŸ·è¡Œæ‰€æœ‰æ‡‰ç”¨ç¨‹å¼é‚è¼¯ -->
    <script type="module">
        // è¼‰å…¥ Firebase æ ¸å¿ƒåŠŸèƒ½
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // [ä¿®æ”¹] ç§»é™¤ auth, è¼‰å…¥æ‰€æœ‰ firestore åŠŸèƒ½
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            runTransaction,
            serverTimestamp,
            updateDoc // [æ–°å¢] è¼‰å…¥ updateDoc ç”¨æ–¼ä¿®æ”¹å¯†ç¢¼
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. å…¨åŸŸè®Šæ•¸èˆ‡ DOM å…ƒç´  ---
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let app, db;
        let currentUserId = null; // [ä¿®æ”¹] å„²å­˜ç™»å…¥è€… ID
        let currentUserName = "è¨ªå®¢"; // [ä¿®æ”¹] å„²å­˜ç™»å…¥è€…å§“å
        let userInventory = { seeds: 0, apples: 0 }; // æœ¬åœ°åº«å­˜å¿«å–
        
        // [ä¿®æ”¹] ç™»å…¥ç‹€æ…‹çš„ KEY
        const LOGGED_IN_KEY = `gg_user_${appId}`;

        // DOM å…ƒç´  (å¿«é€Ÿç™¼é€)
        const sendGiftForm = document.getElementById('send-gift-form');
        const receiverSelect = document.getElementById('receiver-select');
        const giftMessage = document.getElementById('gift-message');
        const giftTypeButtons = document.querySelectorAll('.gift-type-btn');
        const giftAmountInput = document.getElementById('gift-amount');
        const amountDecrease = document.getElementById('amount-decrease');
        const amountIncrease = document.getElementById('amount-increase');
        const submitGiftButton = document.getElementById('submit-gift-button');
        const giftFormMessage = document.getElementById('gift-form-message');
        
        // DOM å…ƒç´  (æˆ‘çš„ç‹€æ…‹)
        const userNameDisplay = document.getElementById('user-name-display');
        const seedCountEl = document.getElementById('seed-count');
        const appleCountEl = document.getElementById('apple-count');
        const goldenAppleCountEl = document.getElementById('golden-apple-count');
        const logoutButton = document.getElementById('logout-button'); // [æ–°å¢]

        // DOM å…ƒç´  (æ„Ÿè¬æ­·ç¨‹)
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const receivedList = document.getElementById('received-list');
        const sentList = document.getElementById('sent-list');

        // DOM å…ƒç´  (ä¿®æ”¹å¯†ç¢¼) [æ–°å¢]
        const passwordForm = document.getElementById('change-password-form');
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const passwordFormMessage = document.getElementById('password-form-message');
        const submitPasswordButton = document.getElementById('submit-password-button');

        let selectedGiftType = null; // 'seed' æˆ– 'apple'

        // --- [ä¿®æ”¹] 2. ç™»å…¥æª¢æŸ¥èˆ‡ Firebase åˆå§‹åŒ– ---

        function checkLoginAndInit() {
            currentUserId = localStorage.getItem(LOGGED_IN_KEY);
            
            if (!currentUserId) {
                // [é‡ç‚¹] ç™»å…¥å®ˆè¡›
                console.log("æœªç™»å…¥ï¼Œè·³è½‰è‡³ login.html");
                // [FIX] å˜—è©¦ä½¿ç”¨ replace ä¸¦ä¸”ç§»é™¤ ./
                window.location.replace('login.html');
                return; // åœæ­¢åŸ·è¡Œ
            }
            
            console.log("å·²ç™»å…¥ä½¿ç”¨è€… ID:", currentUserId);
            initializeAppAndDb();
        }

        async function initializeAppAndDb() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                console.log("Firebase åˆå§‹åŒ–å®Œæˆ (ç°¡æ˜“æ¨¡å¼)ã€‚");
                
                // ç™»å…¥æˆåŠŸï¼Œå•Ÿå‹• App
                setupAppForUser(currentUserId);
                
            } catch (error) { 
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                alert("ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ã€‚");
            }
        }

        // --- 3. æ ¸å¿ƒ App é‚è¼¯ ---

        function setupAppForUser(userId) {
            console.log(`ç‚º ${userId} å•Ÿå‹•æ‡‰ç”¨...`);

            // [ä¿®æ”¹] è³‡æ–™åº«è·¯å¾‘
            const userDocRef = doc(db, `/artifacts/${appId}/users`, userId);
            const usersColRef = collection(db, `/artifacts/${appId}/users`);
            const transactionsColRef = collection(db, `/artifacts/${appId}/transactions`);

            // 3.1 [å³æ™‚] ç›£è½ä½¿ç”¨è€…ç‹€æ…‹ (åº«å­˜)
            onSnapshot(userDocRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    console.error("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™ï¼");
                    alert("æ‰¾ä¸åˆ°æ‚¨çš„è³‡æ–™ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚");
                    handleLogout(); // æ‰¾ä¸åˆ°è³‡æ–™ï¼Œå¼·åˆ¶ç™»å‡º
                    return;
                }
                
                const userData = docSnap.data();
                currentUserName = userData.name;
                
                // æ›´æ–° "æˆ‘çš„ç‹€æ…‹" UI
                userNameDisplay.innerText = userData.name;
                seedCountEl.innerText = userData.seeds;
                appleCountEl.innerText = userData.apples;
                goldenAppleCountEl.innerText = userData.goldenApples;

                // æ›´æ–°æœ¬åœ°åº«å­˜
                userInventory.seeds = userData.seeds;
                userInventory.apples = userData.apples;
                
                // 3.2 [æ–°å¢] æª¢æŸ¥ä¸¦ç™¼æ”¾æ¯æ—¥ç¨®å­
                await checkAndGrantDailySeed(userDocRef, userData);

            }, (error) => {
                console.error("ç›£è½ä½¿ç”¨è€…ç‹€æ…‹å¤±æ•—:", error);
            });

            // 3.3 [ä¸€æ¬¡æ€§] è¼‰å…¥åŒäº‹åå–® (æ’é™¤è‡ªå·±)
            loadColleagues(usersColRef, userId);

            // 3.4 [å³æ™‚] ç›£è½æ„Ÿè¬æ­·ç¨‹
            loadTransactionHistory(transactionsColRef, userId);
            
            // 3.5 [æ–°å¢] ç¶å®šç™»å‡ºæŒ‰éˆ•
            logoutButton.addEventListener('click', handleLogout);

            // 3.6 [æ–°å¢] ç¶å®šä¿®æ”¹å¯†ç¢¼è¡¨å–®
            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleChangePassword(userDocRef);
            });
        }

        // --- 4. åŠŸèƒ½å¯¦ä½œ ---

        // 4.1 æª¢æŸ¥ä¸¦ç™¼æ”¾æ¯æ—¥ç¨®å­
        async function checkAndGrantDailySeed(userRef, userData) {
            const lastSeedAt = userData.lastSeedAt?.toDate();
            const now = new Date();
            
            // æª¢æŸ¥åº«å­˜æ˜¯å¦å·²æ»¿
            if (userData.seeds >= 7) {
                return;
            }

            // æª¢æŸ¥æ˜¯å¦ä»Šå¤©å·²ç¶“é ˜é
            if (lastSeedAt && lastSeedAt.toDateString() === now.toDateString()) {
                return; // ä»Šå¤©é ˜éäº†
            }
            
            console.log("ç™¼æ”¾æ¯æ—¥ç¨®å­...");
            try {
                await updateDoc(userRef, {
                    seeds: userData.seeds + 1,
                    lastSeedAt: serverTimestamp() // è¨˜éŒ„ä»Šå¤©
                });
            } catch (error) {
                console.error("ç™¼æ”¾ç¨®å­å¤±æ•—:", error);
            }
        }
        
        // 4.2 è¼‰å…¥åŒäº‹åå–®
        async function loadColleagues(usersColRef, myId) {
            receiverSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
            let optionsHtml = '';
            try {
                const q = query(usersColRef); // å–å¾—æ‰€æœ‰ä½¿ç”¨è€…
                const querySnapshot = await getDocs(q);
                
                const colleagues = [];
                querySnapshot.forEach((doc) => {
                    if (doc.id !== myId) { // æ’é™¤æˆ‘è‡ªå·±
                        colleagues.push({ id: doc.id, name: doc.data().name });
                    }
                });

                // [ä¿®æ”¹] ä¸æ’åºï¼Œä¿æŒè³‡æ–™åº«åŸå§‹é †åº (è‹¥è¦æ’åºï¼Œåœ¨é€™è£¡ .sort())
                if (colleagues.length === 0) {
                   optionsHtml = '<option value="">ç›®å‰æ²’æœ‰å…¶ä»–åŒäº‹</option>'; 
                } else {
                    optionsHtml = '<option value="">-- é¸æ“‡æ„Ÿè¬å°è±¡ --</option>';
                    colleagues.forEach(colleague => {
                        optionsHtml += `<option value="${colleague.id}">${colleague.name}</option>`;
                    });
                }
                receiverSelect.innerHTML = optionsHtml;
                
            } catch (error) {
                console.error("è¼‰å…¥åŒäº‹åå–®å¤±æ•—:", error);
                receiverSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
            }
        }
        
        // 4.3 è¼‰å…¥æ„Ÿè¬æ­·ç¨‹ (æ”¶åˆ°çš„ & é€å‡ºçš„)
        function loadTransactionHistory(transactionsColRef, myId) {
            // ç›£è½ "æ”¶åˆ°çš„"
            const receivedQuery = query(transactionsColRef, where("receiverId", "==", myId));
            onSnapshot(receivedQuery, (snapshot) => {
                let html = '';
                if (snapshot.empty) {
                    html = '<p class="text-gray-500 py-4">ç›®å‰æ²’æœ‰æ”¶åˆ°çš„æ„Ÿè¬ã€‚</p>';
                } else {
                    const docs = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    // [ä¿®æ”¹] ä¸æ’åºï¼Œç›´æ¥é¡¯ç¤º (è‹¥è¦æ’åºï¼Œåœ¨é€™è£¡ .sort())
                    docs.forEach(tx => {
                        html += `
                            <div class="py-4">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-semibold text-lg text-gray-800">${tx.senderName}</span>
                                    <span class="text-sm text-gray-500">${formatTxTime(tx.createdAt)}</span>
                                </div>
                                <p class="text-gray-700 mb-2">"${tx.message}"</p>
                                <div class="text-right font-medium ${tx.type === 'seed' ? 'text-red-600' : 'text-yellow-600'}">
                                    + ${tx.amount} ${tx.type === 'seed' ? 'ğŸ' : 'ğŸŒŸ'}
                                </div>
                            </div>
                        `;
                    });
                }
                receivedList.innerHTML = html;
            }, (error) => { console.error("è¼‰å…¥æ”¶åˆ°çš„æ„Ÿè¬å¤±æ•—:", error); });
            
            // ç›£è½ "é€å‡ºçš„"
            const sentQuery = query(transactionsColRef, where("senderId", "==", myId));
            onSnapshot(sentQuery, (snapshot) => {
                let html = '';
                if (snapshot.empty) {
                    html = '<p class="text-gray-500 py-4">ç›®å‰æ²’æœ‰é€å‡ºçš„æ„Ÿè¬ã€‚</p>';
                } else {
                    const docs = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    // [ä¿®æ”¹] ä¸æ’åº
                    docs.forEach(tx => {
                        html += `
                            <div class="py-4">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-semibold text-lg text-gray-800">To: ${tx.receiverName}</span>
                                    <span class="text-sm text-gray-500">${formatTxTime(tx.createdAt)}</span>
                                </div>
                                <p class="text-gray-700 mb-2">"${tx.message}"</p>
                                <div class="text-right font-medium text-gray-600">
                                    - ${tx.amount} ${tx.type === 'seed' ? 'ğŸŒ±' : 'ğŸ'}
                                </div>
                            </div>
                        `;
                    });
                }
                sentList.innerHTML = html;
            }, (error) => { console.error("è¼‰å…¥é€å‡ºçš„æ„Ÿè¬å¤±æ•—:", error); });
        }
        
        function formatTxTime(timestamp) {
            if (!timestamp) return 'å‰›å‰›';
            const date = timestamp.toDate();
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffHours < 24) {
                return `${diffHours} å°æ™‚å‰`;
            } else {
                return date.toLocaleDateString();
            }
        }
        
        // 4.4 [æ–°å¢] ç™»å‡º
        function handleLogout() {
            localStorage.removeItem(LOGGED_IN_KEY);
            console.log("å·²ç™»å‡º");
            // [FIX] å˜—è©¦ä½¿ç”¨ replace ä¸¦ä¸”ç§»é™¤ ./
            window.location.replace('login.html');
        }
        
        // 4.5 [æ–°å¢] ä¿®æ”¹å¯†ç¢¼
        async function handleChangePassword(userRef) {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            // æª¢æŸ¥
            if (!newPassword || !confirmPassword) {
                showPasswordMessage("å¯†ç¢¼æ¬„ä½ä¸å¯ç‚ºç©ºã€‚", 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showPasswordMessage("å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ç›¸ç¬¦ã€‚", 'error');
                return;
            }
            if (newPassword.length < 4) { // ç°¡æ˜“çš„é•·åº¦æª¢æŸ¥
                showPasswordMessage("å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 4 å€‹å­—å…ƒã€‚", 'error');
                return;
            }

            // é–å®šæŒ‰éˆ•
            submitPasswordButton.disabled = true;
            submitPasswordButton.innerText = "å„²å­˜ä¸­...";
            
            try {
                // [é‡é»] æ›´æ–°è³‡æ–™åº«ä¸­çš„å¯†ç¢¼ (æ˜æ–‡)
                await updateDoc(userRef, {
                    password: newPassword
                });
                
                showPasswordMessage("å¯†ç¢¼æ›´æ–°æˆåŠŸï¼", 'success');
                passwordForm.reset(); // æ¸…ç©ºè¡¨å–®

            } catch (error) {
                console.error("ä¿®æ”¹å¯†ç¢¼å¤±æ•—:", error);
                showPasswordMessage("æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", 'error');
            }
            
            submitPasswordButton.disabled = false;
            submitPasswordButton.innerText = "å„²å­˜æ–°å¯†ç¢¼";
        }
        
        function showPasswordMessage(message, type) {
            passwordFormMessage.textContent = message;
            if (type === 'error') {
                passwordFormMessage.className = 'text-red-600 text-sm h-5';
            } else if (type === 'success') {
                passwordFormMessage.className = 'text-green-600 text-sm h-5';
            } else {
                passwordFormMessage.className = 'text-sm h-5';
            }
        }

        // --- 5. è¡¨å–®èˆ‡ UI äº’å‹•é‚è¼¯ ---

        // 5.1 æ„Ÿè¬è¡¨å–®æäº¤
        sendGiftForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleGiftSubmit();
        });

        async function handleGiftSubmit() {
            // ç²å–è¡¨å–®è³‡æ–™
            const receiverId = receiverSelect.value;
            const message = giftMessage.value.trim();
            const amount = parseInt(giftAmountInput.value, 10);
            const type = selectedGiftType; // 'seed' æˆ– 'apple'

            // é©—è­‰
            if (!receiverId) {
                showGiftMessage("è«‹é¸æ“‡ä¸€ä½æ„Ÿè¬å°è±¡ã€‚");
                return;
            }
            if (!message) {
                showGiftMessage("æ„Ÿè¬è¨Šæ¯ä¸å¯ç‚ºç©ºã€‚");
                return;
            }
            if (!type) {
                showGiftMessage("è«‹é¸æ“‡è¦é€å‡ºçš„ç¦®ç‰©é¡å‹ã€‚");
                return;
            }
            if (isNaN(amount) || amount < 1) {
                showGiftMessage("æ•¸é‡å¿…é ˆå¤§æ–¼ 0ã€‚");
                return;
            }

            // æª¢æŸ¥åº«å­˜
            if (type === 'seed' && userInventory.seeds < amount) {
                showGiftMessage(`ç¨®å­ä¸è¶³ (æ‚¨åªæœ‰ ${userInventory.seeds} é¡†)ã€‚`);
                return;
            }
            if (type === 'apple' && userInventory.apples < amount) {
                showGiftMessage(`è˜‹æœä¸è¶³ (æ‚¨åªæœ‰ ${userInventory.apples} é¡†)ã€‚`);
                return;
            }

            // é–å®šè¡¨å–®
            submitGiftButton.disabled = true;
            submitGiftButton.innerText = "å‚³é€ä¸­...";
            showGiftMessage("");

            // [ä¿®æ”¹] è³‡æ–™åº«è·¯å¾‘
            const senderRef = doc(db, `/artifacts/${appId}/users`, currentUserId);
            const receiverRef = doc(db, `/artifacts/${appId}/users`, receiverId);
            const transactionsColRef = collection(db, `/artifacts/${appId}/transactions`);
            
            try {
                // åŸ·è¡Œ Firestore äº¤æ˜“
                await runTransaction(db, async (transaction) => {
                    // 1. è®€å–ç™¼é€è€…è³‡æ–™
                    const senderSnap = await transaction.get(senderRef);
                    if (!senderSnap.exists()) {
                        throw "æ‰¾ä¸åˆ°ç™¼é€è€…è³‡æ–™ã€‚";
                    }
                    const senderData = senderSnap.data();

                    // 2. è®€å–æ¥æ”¶è€…è³‡æ–™
                    const receiverSnap = await transaction.get(receiverRef);
                    if (!receiverSnap.exists()) {
                        throw "æ‰¾ä¸åˆ°æ¥æ”¶è€…è³‡æ–™ã€‚";
                    }
                    const receiverData = receiverSnap.data();
                    
                    // 3. å†æ¬¡æª¢æŸ¥åº«å­˜ (é›™é‡ä¿éšª)
                    if (type === 'seed' && senderData.seeds < amount) {
                        throw `ç¨®å­ä¸è¶³ (æ‚¨åªæœ‰ ${senderData.seeds} é¡†)ã€‚`;
                    }
                    if (type === 'apple' && senderData.apples < amount) {
                        throw `è˜‹æœä¸è¶³ (æ‚¨åªæœ‰ ${senderData.apples} é¡†)ã€‚`;
                    }

                    // 4. è¨ˆç®—æ›´æ–°
                    let senderUpdates = {};
                    let receiverUpdates = {};

                    if (type === 'seed') {
                        senderUpdates = {
                            seeds: senderData.seeds - amount,
                            gardenerPoints: (senderData.gardenerPoints || 0) + amount
                        };
                        receiverUpdates = {
                            apples: receiverData.apples + amount
                        };
                    } else { // type === 'apple'
                        senderUpdates = {
                            apples: senderData.apples - amount,
                            gardenerPoints: (senderData.gardenerPoints || 0) + (amount * 5) // é€è˜‹æœ 5 å€ç©åˆ†
                        };
                        receiverUpdates = {
                            goldenApples: receiverData.goldenApples + amount
                        };
                    }

                    // 5. å¯«å…¥æ›´æ–°
                    transaction.update(senderRef, senderUpdates);
                    transaction.update(receiverRef, receiverUpdates);

                    // 6. å¯«å…¥äº¤æ˜“ç´€éŒ„
                    const newTxRef = doc(transactionsColRef); // è‡ªå‹•ç”¢ç”Ÿ ID
                    transaction.set(newTxRef, {
                        senderId: currentUserId,
                        senderName: currentUserName,
                        receiverId: receiverId,
                        receiverName: receiverData.name,
                        type: type,
                        amount: amount,
                        message: message,
                        createdAt: serverTimestamp()
                    });
                });

                // äº¤æ˜“æˆåŠŸ
                console.log("äº¤æ˜“æˆåŠŸï¼");
                sendGiftForm.reset(); // é‡è¨­è¡¨å–®
                selectedGiftType = null;
                giftTypeButtons.forEach(btn => btn.classList.remove('bg-yellow-400', 'bg-red-400', 'ring-2', 'ring-offset-1', 'ring-orange-500'));
                giftAmountInput.value = 1;
                showGiftMessage("æ„Ÿè¬å·²æˆåŠŸé€å‡ºï¼", 'success');
                
            } catch (error) {
                // äº¤æ˜“å¤±æ•—
                console.error("äº¤æ˜“å¤±æ•—:", error);
                // é¡¯ç¤ºè‡ªå®šç¾©çš„éŒ¯èª¤è¨Šæ¯
                showGiftMessage(typeof error === 'string' ? error : "å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", 'error');
            }

            // è§£é–è¡¨å–®
            submitGiftButton.disabled = false;
            submitGiftButton.innerText = "é€å‡ºæ„Ÿè¬";
        }
        
        function showGiftMessage(message, type = 'error') {
            giftFormMessage.textContent = message;
            if (type === 'error') {
                giftFormMessage.className = 'text-red-600 text-sm h-5';
            } else if (type === 'success') {
                giftFormMessage.className = 'text-green-600 text-sm h-5';
            }
        }

        // 5.2 ç¦®ç‰©é¡å‹æŒ‰éˆ•
        giftTypeButtons.forEach(button => {
            button.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„é«˜äº®
                giftTypeButtons.forEach(btn => {
                    btn.classList.remove('bg-yellow-400', 'bg-red-400', 'ring-2', 'ring-offset-1', 'ring-orange-500');
                    btn.classList.add('bg-gray-200');
                });
                
                // è¨­ç½®é¸ä¸­çš„é¡å‹
                selectedGiftType = button.dataset.giftType;
                
                // é«˜äº®é¸ä¸­çš„æŒ‰éˆ•
                button.classList.remove('bg-gray-200');
                if (selectedGiftType === 'seed') {
                    button.classList.add('bg-yellow-400', 'ring-2', 'ring-offset-1', 'ring-orange-500');
                } else {
                    button.classList.add('bg-red-400', 'ring-2', 'ring-offset-1', 'ring-orange-500');
                }
            });
        });
        
        // 5.3 æ•¸é‡æŒ‰éˆ•
        amountDecrease.addEventListener('click', () => {
            let currentAmount = parseInt(giftAmountInput.value, 10);
            if (currentAmount > 1) {
                giftAmountInput.value = currentAmount - 1;
            }
        });
        amountIncrease.addEventListener('click', () => {
            let currentAmount = parseInt(giftAmountInput.value, 10);
            giftAmountInput.value = currentAmount + 1;
        });
        
        // 5.4 æ­·ç¨‹åˆ†é 
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                
                // æ›´æ–°æŒ‰éˆ•æ¨£å¼
                tabButtons.forEach(btn => {
                    btn.classList.remove('border-orange-500', 'text-orange-600');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });
                button.classList.add('border-orange-500', 'text-orange-600');
                button.classList.remove('border-transparent', 'text-gray-500');
                
                // é¡¯ç¤ºå°æ‡‰å…§å®¹
                tabContents.forEach(content => {
                    if (content.id === `tab-${tabId}`) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });
            });
        });

        // --- 6. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ ---
        checkLoginAndInit(); // [ä¿®æ”¹] å•Ÿå‹•æ™‚å…ˆæª¢æŸ¥ç™»å…¥

    </script>

</body>
</html>

